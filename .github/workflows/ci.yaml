name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write

jobs:
  # 任务 1: 测试
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      # 使用 Makefile 运行测试
      # test-ci 不使用 -cover，避免 Go 1.22 的 covdata 问题
      - name: Run Tests
        run: make test-ci

  # 任务 2: 构建 (仅在打 tag 时运行)
  release:
    needs: test
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # 【关键点】
          # git describe 需要历史记录来计算版本号
          # fetch-depth: 0 表示拉取完整历史，否则 Makefile 里的 VERSION 可能是 "dev"
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      # 使用 Makefile 进行交叉编译
      # 所有的 TAGS 和 LDFLAGS 都在 Makefile 里管理，这里极其清爽
      - name: Build All Platforms
        run: make build-all

      # 生成 SHA256 校验和
      - name: Generate Checksums
        run: |
          cd bin
          sha256sum sing-helm-* > checksums.txt
          cat checksums.txt

      # 上传产物 (备份到 Actions)
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sing-helm-release
          path: bin/

      # 创建 GitHub Release 并上传文件
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: |
            bin/sing-helm-*
            bin/checksums.txt
          draft: false # 创建为草稿，方便手动编辑 Release Note 后再发布
          prerelease: ${{ contains(github.ref, '-') }} # 自动检测：tag 包含 '-' 则为预发布版
          generate_release_notes: true # 自动生成 Release Notes（基于 commits 和 PRs）
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 更新 Homebrew Formula
      - name: Update Homebrew Formula
        if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-')
        env:
          GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: .github/scripts/update-homebrew.sh ${GITHUB_REF#refs/tags/v}
